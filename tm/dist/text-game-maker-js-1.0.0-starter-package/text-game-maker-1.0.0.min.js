/*
 * Copyright 2017 a.mean.blogger@gmail.com
 * GitHub: https://github.com/a-mean-blogger/text-game-maker-js
 * license: MIT
 */
var TM={};TM.defaultSettings={screen:{canvasId:"tm-canvas",fontSize:30,frameSpeed:10,zoom:.5,column:60,row:20,backgroundColor:"#151617",defaultFontColor:"#F5F7FA",webFontJsPath:"https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js",fontFamily:"monospace",fontSource:null},charGroups:{korean:{regex:"ㄱ-힝",isFullwidth:!0,sizeAdj:1,xAdj:0,yAdj:0}},debug:{devMode:!1,outputDomId:"tm-debug-output"}},TM.common={},TM.common.getBlockWidth=function(t){return.6*t},TM.common.getBlockHeight=function(t){var e;if(t<3)e=t;else{var o=[6,7,7],r=0,n=1,i=function(t){t-o[r]<=0||(t-=o[r],n++,r=(r+1)%3,i(t))};i(t-3),e=t+n}return e},TM.common.isNumber=function(t){return!!(0===t||t&&t.constructor==Number)},TM.common.getCharGroup=function(t,e){for(var o in t){var r=t[o];if(new RegExp("^["+r.regex+"]$").test(e))return r}},TM.common.getFullwidthRegex=function(t){var e="";for(var o in t){var r=t[o];r&&r.isFullwidth&&(e+=r.regex)}if(e)return new RegExp("(["+e+"])","g")},TM.common.includeScript=function(t,e){if(t){var o=document.querySelector('script[src="'+t+'"]');o||((o=document.createElement("script")).src=t,o.onload=e,document.getElementsByTagName("head")[0].appendChild(o))}},TM.common.checkFontLoadedByWebFont=function(t){var e=t.replace(/ /g,"").toLowerCase();return!!document.querySelector(".wf-"+e+"-n4-active")},TM.common.mergeObjects=function(t,e){for(var o={},r=[t,e],n=0;n<r.length;n++)for(var i in r[n])o[i]=r[n][i];return o},TM.IObject=function(t,e){this.data=TM.common.mergeObjects(this.data,t),e||this.init()},TM.IObject.prototype.init=function(){this._init(),this.isActive=!0},TM.IObject.prototype.destroy=function(){this._destroy(),this.isActive=!1},TM.IObject.prototype._init=function(){},TM.IObject.prototype._destroy=function(){},TM.Interval=function(){this.id=null,this.func=null,this.speed=null},TM.Interval.prototype.stop=function(){this.id&&window.clearInterval(this.id),this.id=null},TM.Interval.prototype.start=function(){this.stop();var t=this;this.id=window.setInterval(function(){t.func()},this.speed)},TM.Interval.prototype.setSpeed=function(t){this.speed=t,this.start()},TM.Interval.prototype.init=function(t,e){this.speed=t,this.func=e,this.start()},TM.ILoopObject=function(t,e,o){this.speed=t,this.interval=new TM.Interval,TM.IObject.call(this,e,o)},TM.ILoopObject.prototype=Object.create(TM.IObject.prototype),TM.ILoopObject.prototype.constructor=TM.ILoopObject,TM.ILoopObject.prototype.init=function(){TM.IObject.prototype.init.call(this);var t=this;this.interval.init(this.speed,function(){t.isActive&&t.calculate(),t.isActive&&t.draw()}),this.draw()},TM.ILoopObject.prototype.destroy=function(){TM.IObject.prototype.destroy.call(this),this.interval.stop()},TM.ILoopObject.prototype.calculate=function(){this._calculate()},TM.ILoopObject.prototype.draw=function(){this._draw()},TM.ILoopObject.prototype._init=function(){},TM.ILoopObject.prototype._destroy=function(){},TM.ILoopObject.prototype._calculate=function(){},TM.ILoopObject.prototype._draw=function(){},TM.IProgram=function(t,e,o){this.loopCount=0,this.objects=TM.common.mergeObjects(this.objects,o),TM.ILoopObject.call(this,t,e,!0)},TM.IProgram.prototype=Object.create(TM.ILoopObject.prototype),TM.IProgram.prototype.constructor=TM.IProgram,TM.IProgram.prototype.init=function(){TM.ILoopObject.prototype.init.call(this),this.loopCount=0},TM.IProgram.prototype.destroy=function(){TM.ILoopObject.prototype.destroy.call(this);for(var t in this.objects)if(Array.isArray(this.objects[t]))for(var e=this.objects[t].length-1;e>=0;e--)this.objects[t][e].destroy();else this.objects[t]&&this.objects[t].destroy()},TM.IProgram.prototype.calculate=function(){TM.ILoopObject.prototype.calculate.call(this),this.loopCount++,this.timeline(this.loopCount),this.getInput()},TM.IProgram.prototype.draw=function(){TM.ILoopObject.prototype.draw.call(this),this._draw()},TM.IProgram.prototype.timeline=function(t){this._timeline(t)},TM.IProgram.prototype.getInput=function(){this._getInput()},TM.IProgram.prototype._init=function(){},TM.IProgram.prototype._destroy=function(){},TM.IProgram.prototype._calculate=function(){},TM.IProgram.prototype._draw=function(){},TM.IProgram.prototype._timeline=function(t){},TM.IProgram.prototype._getInput=function(){},TM.ScreenManager_Char=function(t,e,o,r,n){this.char=e,this.isFullwidth=o,this.color=r||t.defaultFontColor,this.backgroundColor=n||t.backgroundColor,this.font=t.fontFamily,this.isNew=!0},TM.ScreenManager_Cursor=function(t){this.speed=500,this.data={refScreenManager:void 0,x:0,y:0,xMax:void 0,yMax:void 0,color:"gray",width:this.blockWidth,size:.1,isHidden:!1,isUpdated:!0},TM.ILoopObject.call(this,this.speed,t)},TM.ScreenManager_Cursor.prototype=Object.create(TM.ILoopObject.prototype),TM.ScreenManager_Cursor.prototype.constructor=TM.ScreenManager_Cursor,TM.ScreenManager_Cursor.prototype._init=function(){},TM.ScreenManager_Cursor.prototype._destroy=function(){},TM.ScreenManager_Cursor.prototype._calculate=function(){this.data.isHidden=!this.data.isHidden,this.data.isUpdated=!0},TM.ScreenManager_Cursor.prototype._draw=function(){},TM.ScreenManager_Cursor.prototype.move=function(t,e){var o=!1;if(t>=0&&t<=this.data.xMax&&e>=0&&e<=this.data.yMax){var r=this.data.refScreenManager;r.screenData[this.data.y+r.scrollOffsetY][this.data.x].isNew=!0,o=!0,this.data.x=t,this.data.y=e}return o},TM.ScreenManager_Cursor.prototype.hide=function(){this.data.isHidden=!0,this.interval.stop()},TM.ScreenManager_Cursor.prototype.show=function(){this.data.isHidden=!1,this.interval.start()},TM.ScreenManager=function(t,e){this.screenSetting=TM.common.mergeObjects(TM.defaultSettings.screen,t),this.charGroups=TM.common.mergeObjects(TM.defaultSettings.charGroups,e),this.speed=this.screenSetting.frameSpeed;try{if(this.canvas=document.querySelector("#"+this.screenSetting.canvasId),!this.canvas)throw"[#"+this.screenSetting.canvasId+"] does not exist! ";if("CANVAS"!==this.canvas.tagName)throw"[#"+this.screenSetting.canvasId+"] is not a canvas! "}catch(t){return this.isActive=!1,void console.error("new TM.ScreenManager ERROR: "+t+" TM.ScreenManager is not created correctly.")}this.isFontLoaded=!1,this.screenData=[],this.blockWidth=TM.common.getBlockWidth(this.screenSetting.fontSize),this.blockHeight=TM.common.getBlockHeight(this.screenSetting.fontSize),this.canvas.width=this.blockWidth*this.screenSetting.column,this.canvas.height=this.blockHeight*this.screenSetting.row,this.canvas.style.border=this.screenSetting.backgroundColor+" 1px solid",this.canvas.style.borderRadius="5px",this.canvas.style.backgroundColor=this.screenSetting.backgroundColor,this.canvas.style.width=this.canvas.width*this.screenSetting.zoom+"px",this.canvas.style.height=this.canvas.height*this.screenSetting.zoom+"px",this.canvas.tabIndex=1,this.canvas.style.outline="none",this.ctx=this.canvas.getContext("2d"),this.scrollOffsetY=0,this.cursor=new TM.ScreenManager_Cursor({refScreenManager:this,xMax:this.screenSetting.column-1,yMax:this.screenSetting.row-1,color:"gray",width:this.blockWidth,size:.1}),TM.ILoopObject.call(this,this.speed)},TM.ScreenManager.prototype=Object.create(TM.ILoopObject.prototype),TM.ScreenManager.prototype.constructor=TM.ScreenManager,TM.ScreenManager.prototype._init=function(){this.resetScreenData(),this.screenSetting.fontSource&&!TM.common.checkFontLoadedByWebFont(this.screenSetting.fontFamily)&&this.startLoadingFont()},TM.ScreenManager.prototype._destroy=function(){},TM.ScreenManager.prototype._calculate=function(){!this.isFontLoaded&&TM.common.checkFontLoadedByWebFont(this.screenSetting.fontFamily)&&(this.isFontLoaded=!0,this.refreshScreen()),this.checkReady()?this.onReadyFunc&&(this.onReadyFunc(),delete this.onReadyFunc):this.showLoading()},TM.ScreenManager.prototype._draw=function(){var t=this.ctx;t.textBaseline="buttom";for(var e=this.getNewBgUpdateMap(),o=this.scrollOffsetY;o<this.scrollOffsetY+this.screenSetting.row;o++)for(var r=0;r<this.screenSetting.column;r++)if(!0===this.screenData[o][r].isNew){if(!e[o][r]){var n=this.blockWidth*r,i=this.blockHeight*(o-this.scrollOffsetY),s=this.getBackgroundWidthRecursive(o,r,e),a=this.blockHeight;t.fillStyle=this.screenData[o][r].backgroundColor,t.fillRect(n,i,s,a)}if(this.screenData[o][r].char&&"$"!=this.screenData[o][r].char[0]){var c=this.blockWidth*r,h=this.blockHeight*(o-this.scrollOffsetY)+.8*this.blockHeight,p=TM.common.getCharGroup(this.charGroups,this.screenData[o][r].char);p?(t.font=this.screenSetting.fontSize*p.sizeAdj+"px "+this.screenData[o][r].font,c+=this.blockWidth*p.xAdj,h+=this.blockHeight*p.yAdj):t.font=this.screenSetting.fontSize+"px "+this.screenData[o][r].font,t.fillStyle=this.screenData[o][r].color,t.fillText(this.screenData[o][r].char[0],c,h)}this.screenData[o][r].isNew=!1}var u=this.cursor.data;if(u.isUpdated)if(u.isUpdated=!1,u.isHidden)this.screenData[u.y+this.scrollOffsetY][u.x].isNew=!0;else{var d=u.width,l=this.blockHeight*u.size,g=this.blockWidth*u.x,M=this.blockHeight*u.y+(this.blockHeight-l);t.fillStyle=u.color,t.fillRect(g,M,d,l)}},TM.ScreenManager.prototype.startLoadingFont=function(){if(!this.screenSetting.webFontJsPath)return console.error("TM.ScreenManager ERROR: 'webFontJsPath' is required to load font from 'fontSource'!");window.WebFont?this.loadWebFont():TM.common.includeScript(this.screenSetting.webFontJsPath,this.loadWebFont())},TM.ScreenManager.prototype.loadWebFont=function(){var t=this;return function(){WebFont.load({custom:{families:[t.screenSetting.fontFamily],urls:[t.screenSetting.fontSource]}})}},TM.ScreenManager.prototype.resetScreenData=function(){this.screenData=[];for(var t=this.scrollOffsetY;t<this.scrollOffsetY+this.screenSetting.row;t++){this.screenData[t]=[];for(var e=0;e<this.screenSetting.column;e++)this.screenData[t][e]=new TM.ScreenManager_Char(this.screenSetting," ")}},TM.ScreenManager.prototype.getNewBgUpdateMap=function(){for(var t=[],e=this.scrollOffsetY;e<this.scrollOffsetY+this.screenSetting.row;e++){t[e]=[];for(var o=0;o<this.screenSetting.column;o++)t[e][o]=!1}return t},TM.ScreenManager.prototype.getBackgroundWidthRecursive=function(t,e,o){return o[t][e]=!0,e+1<this.screenSetting.column&&this.screenData[t][e+1].isNew&&this.screenData[t][e].backgroundColor==this.screenData[t][e+1].backgroundColor?this.getBackgroundWidthRecursive(t,e+1,o)+this.blockWidth:this.blockWidth},TM.ScreenManager.prototype.refreshScreen=function(){for(var t=0;t<this.screenData.length;t++)for(var e=0;e<this.screenData[t].length;e++)this.screenData[t][e].isNew=!0},TM.ScreenManager.prototype.isInScreen=function(t,e){var o=!1;return t>=0&&e>=0&&e<this.screenSetting.row&&t<this.screenSetting.column&&(o=!0),o},TM.ScreenManager.prototype.insertChar=function(t,e,o){var r=this.cursor.data.x,n=this.cursor.data.y,i=this.cursor.data.x,s=this.cursor.data.y+this.scrollOffsetY;if(this.isInScreen(r,n)){if(this.screenData[s][i].char!=t||this.screenData[s][i].color!=(e||this.screenSetting.defaultFontColor)||this.screenData[s][i].backgroundColor!=(o||this.screenSetting.backgroundColor)||"$"==this.screenData[s][i].char[0]&&this.screenData[s][i-1].isNew){var a=TM.common.getFullwidthRegex(this.charGroups).test(t);this.screenData[s][i]=new TM.ScreenManager_Char(this.screenSetting,t,a,e,o),this.isInScreen(r-1,n)&&(this.screenData[s][i-1].draw=!0),this.isInScreen(r+(a?2:1),n)&&(this.screenData[s][i+(a?2:1)].draw=!0)}r+1>=this.screenSetting.column&&n+1<this.screenSetting.row?this.cursor.move(0,n+1):r+1>=this.screenSetting.column&&n+1>=this.screenSetting.row?(this.cursor.move(0,n),this.scrollDown()):this.cursor.move(r+1,n)}},TM.ScreenManager.prototype.showLoading=function(){this.insertTextAt(0,0,"Loading...")},TM.ScreenManager.prototype.onReady=function(t){this.checkReady()?this.onReadyFunc():this.onReadyFunc=t},TM.ScreenManager.prototype.checkReady=function(){return!this.screenSetting.fontSource||this.isFontLoaded},TM.ScreenManager.prototype.fillScreen=function(t,e,o){for(var r=this.scrollOffsetY;r<this.scrollOffsetY+this.screenSetting.row;r++)for(var n=0;n<this.screenSetting.column;n++)this.screenData[r][n]=new TM.ScreenManager_Char(this.screenSetting,t,!1,e,o)},TM.ScreenManager.prototype.scrollDown=function(){var t=this.scrollOffsetY+this.screenSetting.row;if(!this.screenData[t]){this.screenData[t]=[];for(var e=0;e<this.screenSetting.column;e++)this.screenData[t][e]=new TM.ScreenManager_Char(this.screenSetting," ")}this.scrollOffsetY++,this.refreshScreen()},TM.ScreenManager.prototype.scrollUp=function(){this.scrollOffsetY>0&&this.scrollOffsetY--,this.refreshScreen()},TM.ScreenManager.prototype.clearScreen=function(){this.fillScreen(" ")},TM.ScreenManager.prototype.insertText=function(t,e,o){var r=TM.common.getFullwidthRegex(this.charGroups);t=t.toString().replace(r,"$1 ");for(var n=this.cursor.data.x,i=0;i<t.length;i++)switch(t[i]){case"\n":(s=this.cursor.data).y+1<this.screenSetting.row?this.cursor.move(n,s.y+1):(this.cursor.move(n,s.y),this.scrollDown());break;case"\r":var s=this.cursor.data;this.cursor.move(0,s.y);break;default:var a=r.test(t[i]);this.insertChar(t[i],e,o),a&&(i++,this.insertChar("$fullwidthFiller",e,o))}},TM.ScreenManager.prototype.insertTextAt=function(t,e,o,r,n){this.cursor.move(t,e)&&this.insertText(o,r,n)},TM.ScreenManager.prototype.deleteText=function(t){var e=TM.common.getFullwidthRegex(this.charGroups);t=t.toString().replace(e,"$1 "),this.insertText(t.replace(/./g," "))},TM.ScreenManager.prototype.deleteTextAt=function(t,e,o){this.cursor.move(t,e)&&this.deleteText(o)},TM.ScreenManager.prototype.copyScreen=function(){var t=document.createElement("canvas"),e=t.getContext("2d");return t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0),t},TM.ScreenManager.prototype.pasteScreen=function(t){this.ctx.drawImage(t,0,0)},TM.ScreenManager.prototype.consoleScreenData=function(t){for(var e=this.scrollOffsetY;e<this.scrollOffsetY+this.screenSetting.row;e++){for(var o="",r=0;r<this.screenSetting.column;r++)o+=this.screenData[e][r].char[0]+(this.screenData[e][r].isNew?"!":" ");console.log(o)}},TM.InputManager_Keyboard=function(t){this.isAllowed=!0,this.refInputManager=t,this.keyState={},this.keyPressed={};var e=this;this.eventHandlers={keydown:function(t){t.preventDefault(),e.refInputManager.isAllowed&&e.isAllowed&&(e.keyState[t.keyCode]=!0,e.keyPressed[t.keyCode]=!0),e.refInputManager.devMode&&console.log("Keyboard Key Pressed keyCode: ",t.keyCode)},keyup:function(t){t.preventDefault(),delete e.keyState[t.keyCode]}},TM.IObject.call(this)},TM.InputManager_Keyboard.prototype=Object.create(TM.IObject.prototype),TM.InputManager_Keyboard.prototype.constructor=TM.InputManager_Keyboard,TM.InputManager_Keyboard.prototype._init=function(){this.refInputManager.targetDom.addEventListener("keydown",this.eventHandlers.keydown),this.refInputManager.targetDom.addEventListener("keyup",this.eventHandlers.keyup)},TM.InputManager_Keyboard.prototype._destroy=function(){},TM.InputManager_Keyboard.prototype.getInput=function(t){return prompt(t)},TM.InputManager_Keyboard.prototype.checkKeyState=function(t){return!!this.keyState[t]},TM.InputManager_Keyboard.prototype.checkKeyStateAny=function(){return!!Object.keys(this.keyState).length},TM.InputManager_Keyboard.prototype.removeKeyState=function(t){delete this.keyState[t]},TM.InputManager_Keyboard.prototype.clearKeyState=function(){this.keyState={}},TM.InputManager_Keyboard.prototype.isAllowed=function(t){return this.isAllowed},TM.InputManager_Keyboard.prototype.disAllow=function(t){this.isAllowed=!1},TM.InputManager_Keyboard.prototype.allow=function(t){this.isAllowed=!0},TM.InputManager_Keyboard.prototype.checkKeyPressed=function(t){return!!this.keyPressed[t]&&(delete this.keyPressed[t],!0)},TM.InputManager_Keyboard.prototype.checkKeyPressedAny=function(){return!!Object.keys(this.keyPressed).length&&(this.keyPressed={},!0)},TM.InputManager_Keyboard.prototype.removeKeyPressed=function(t){delete this.keyPressed[t]},TM.InputManager_Keyboard.prototype.clearKeyPressed=function(){this.keyPressed={}},TM.InputManager_Keyboard.prototype.checkKey=function(t){return this.checkKeyPressed(t)||this.checkKeyState(t)},TM.InputManager_Keyboard.prototype.checkKeyAny=function(){return this.checkKeyPressedAny()||this.checkKeyStateAny()},TM.InputManager_Keyboard.prototype.removeKey=function(t){this.removeKeyPressed(t),this.removeKeyState(t)},TM.InputManager_Keyboard.prototype.clearKey=function(){this.clearKeyPressed(),this.clearKeyState()},TM.InputManager=function(t,e){var o=t||TM.defaultSettings.screen.canvasId;try{if(this.targetDom=document.querySelector("#"+o),!this.targetDom)throw"[#"+domId+"] does not exist! "}catch(t){return this.isActive=!1,void console.error("new TM.InputManager ERROR: "+t+" TM.InputManager is not created.")}this.isAllowed=!0,this.devMode=e,this.keyboard=new TM.InputManager_Keyboard(this),TM.IObject.call(this)},TM.InputManager.prototype=Object.create(TM.IObject.prototype),TM.InputManager.prototype.constructor=TM.InputManager,TM.InputManager.prototype._init=function(){},TM.InputManager.prototype._destroy=function(){},TM.InputManager.prototype.isAllowed=function(t){return this.isAllowed},TM.InputManager.prototype.disAllow=function(t){this.isAllowed=!1},TM.InputManager.prototype.allow=function(t){this.isAllowed=!0},TM.DebugManager=function(t){this.debugSetting=TM.common.mergeObjects(TM.defaultSettings.debug,t);try{if(this.outputDom=document.querySelector("#"+this.debugSetting.outputDomId),!this.outputDom)throw"[#"+this.debugSetting.outputDomId+"] does not exist! "}catch(t){return this.isActive=!1,void console.error("new TM.DebugManager ERROR: "+t+" TM.DebugManager is not created.")}this.doms={},TM.IObject.call(this)},TM.DebugManager.prototype=Object.create(TM.IObject.prototype),TM.DebugManager.prototype.constructor=TM.DebugManager,TM.DebugManager.prototype._init=function(){},TM.DebugManager.prototype._destroy=function(){this.deleteAll()},TM.DebugManager.prototype.print=function(t,e){if(this.debugSetting.devMode&&this.isActive){this.doms[t]||(this.doms[t]=document.createElement("div"),this.outputDom.appendChild(this.doms[t]));var o="";for(var r in e)o+=r+": "+e[r]+"\n";this.doms[t].innerText=o}else this.delete(t)},TM.DebugManager.prototype.delete=function(t){this.doms[t]&&(this.doms[t].remove?this.doms[t].remove():this.doms[t].parentElement.removeChild(this.doms[t]),delete this.doms[t])},TM.DebugManager.prototype.deleteAll=function(){for(var t in this.doms)this.delete(t)};